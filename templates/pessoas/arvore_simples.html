<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Minha Árvore Genealógica</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background-color: #f8f9fa;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container.mt-4 {
            padding: 20px;
            box-sizing: border-box;
            width: 100%;
            max-width: 1200px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #343a40;
        }

        .tree-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,.08);
            overflow-x: auto;
            min-width: fit-content;
            margin: 0 auto;
            width: 100%;
        }
        
        .tree-level {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            gap: 30px;
            flex-wrap: wrap;
            margin-bottom: 80px;
            position: relative;
            padding-top: 20px;
            width: 100%;
        }
        
        .tree-level:first-child {
            padding-top: 0;
            margin-top: 0;
        }

        .person-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,.05);
            width: 180px;
            height: 200px;
            position: relative;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .person-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
        }
        .person-card.is-root-node {
            background-color: #0d6efd;
            color: white;
            border-color: #0a58ca;
            box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3);
        }
        
        .person-card.is-root-node {
            background-color: #0d6efd;
            color: white;
            border-color: #0a58ca;
            box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3);
        }
        
        .person-card.is-root-node .person-card-inner-content .person-img {
            border-color: white !important;
        }

        .person-card:not(.is-root-node) .badge.bg-success {
            background-color: #28a745 !important;
            color: #212529 !important;
        }

        .person-card.is-root-node .badge.bg-success {
            background-color: #6c757d !important;
            color: white !important;
        }

        .person-card .person-card-inner-content .name .badge.bg-success {
            background-color: #28a745 !important;
            color: #212529 !important;
            border: 1px solid #79d799;
        }

        .person-card .person-card-inner-content.is-user-selected-card {
            border: 2px solid #6cb2eb;
            box-shadow: 0 0 10px rgba(108, 178, 235, 0.5);
        }

        .person-card:not(.is-root-node) .person-card-inner-content .card-title,
        .person-card:not(.is-root-node) .person-card-inner-content .details small {
            color: #343a40 !important;
        }
        
        /* --- Linhas de Conexão com CSS Puro --- */
        .tree-level::before { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 2px; height: 20px; background-color: #888; z-index: 1; }
        .tree-level:first-child::before { content: none; }

        .tree-level::after { content: ''; position: absolute; top: 20px; left: 0; right: 0; height: 2px; background-color: #888; z-index: 1; }
        .tree-level:first-child::after { content: none; }

        .person-card::before { content: ''; position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 2px; height: 20px; background-color: #888; z-index: 2; }
        .tree-level:first-child .person-card::before { content: none; }

        .tree-level:not(:last-child)::after { 
            content: ''; position: absolute; bottom: -60px; left: 50%; transform: translateX(-50%); width: 2px; height: 60px; background-color: #888; z-index: 0; 
        }
        .tree-level:last-child::after { content: none; }

        .back-button-container {
            width: 100%;
            text-align: center;
            margin-top: 40px;
            margin-bottom: 20px;
        }

        .modal-body img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Árvore Genealógica</h1>
        {% load custom_filters %} 

        {# NOVO: Seção para exibir as origens regionais #}
        {% if regioes_familiares %}
        <div class="card p-3 mb-4 shadow-sm">
            <h4 class="card-title text-center mb-3">Origens Regionais da Família</h4>
            <div class="row justify-content-center">
                {% for item in regioes_familiares %}
                <div class="col-auto mb-2">
                    <span class="badge bg-primary fs-6 py-2 px-3">
                        {{ item.regiao }}: {{ item.count }} parentes
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if message %}
            <div class="alert alert-warning">{{ message }}</div>
        {% elif tree_levels %} 
            <div class="tree-container">
                {% for level_data in tree_levels %}
                    <div class="tree-level">
                        {% for person_data in level_data.nodes %}
                            <div class="person-card {% if person_data.is_root_display_node %}is-root-node{% endif %}">
                                {# Inclui o template do cartão da pessoa, sem o modal interno #}
                                {% include 'pessoas/_person_card.html' with person_data=person_data %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-warning">Nenhuma pessoa para exibir a árvore.</div>
        {% endif %}
        <div class="back-button-container">
            <a href="{% url 'lista_pessoas' %}" class="btn btn-secondary">Voltar para a lista</a>
        </div>
    </div>

    {# O MODAL GENÉRICO: Apenas um modal no DOM #}
    <div class="modal fade" id="personDetailsModal" tabindex="-1" aria-labelledby="personDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="personDetailsModalLabel">Detalhes da Pessoa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-start">
                    <div class="text-center mb-3">
                        <img id="modalPersonPhoto" src="" alt="" class="img-fluid rounded-circle" style="max-height: 200px; width: 150px; height: 150px; object-fit: cover; border: 4px solid #f0f0f0;">
                    </div>
                    <p><strong>Nome:</strong> <span id="modalPersonName"></span></p>
                    <p><strong>Data de Nascimento:</strong> <span id="modalPersonBirthDate"></span></p>
                    <p><strong>Idade:</strong> <span id="modalPersonAge"></span></p>
                    <p><strong>Data de Falecimento:</strong> <span id="modalPersonDeathDate"></span></p>
                    <p><strong>Gênero:</strong> <span id="modalPersonGender"></span></p>
                    <p><strong>Pai:</strong> <span id="modalPersonFather"></span></p>
                    <p><strong>Mãe:</strong> <span id="modalPersonMother"></span></p>
                    <p><strong>Parentesco em relação a você:</strong> <span id="modalPersonRelationship"></span></p>
                    <p><strong>Status de Vida:</strong> <span id="modalPersonStatus"></span></p>
                    <p><strong>Local de Nascimento:</strong> <span id="modalPersonLocalNascimento"></span></p>
                    <p><strong>Estado de Nascimento:</strong> <span id="modalPersonEstadoNascimento"></span></p> {# NOVO #}
                    <div id="modalPersonHistoryContainer" style="display: none;">
                        <p><strong>História Pessoal:</strong></p>
                        <p id="modalPersonHistory"></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <a id="modalEditButton" href="#" class="btn btn-warning">Editar</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    {# Script para passar os dados da árvore para o JavaScript. Use json_script para segurança. #}
    {{ all_tree_data|json_script:"all-tree-data" }}

    <script>
        // Pega os dados JSON que foram embutidos pelo Django
        const allTreeDataElement = document.getElementById('all-tree-data');
        const allTreeData = JSON.parse(allTreeDataElement.textContent);
        const personsData = allTreeData.persons;

        // Seleciona o modal e seus elementos internos para preenchimento
        const personDetailsModal = document.getElementById('personDetailsModal');
        const modalTitle = document.getElementById('personDetailsModalLabel');
        const modalPersonPhoto = document.getElementById('modalPersonPhoto');
        const modalPersonName = document.getElementById('modalPersonName');
        const modalPersonBirthDate = document.getElementById('modalPersonBirthDate');
        const modalPersonAge = document.getElementById('modalPersonAge');
        const modalPersonDeathDate = document.getElementById('modalPersonDeathDate');
        const modalPersonGender = document.getElementById('modalPersonGender');
        const modalPersonFather = document.getElementById('modalPersonFather');
        const modalPersonMother = document.getElementById('modalPersonMother');
        const modalPersonRelationship = document.getElementById('modalPersonRelationship');
        const modalPersonStatus = document.getElementById('modalPersonStatus');
        const modalPersonLocalNascimento = document.getElementById('modalPersonLocalNascimento');
        const modalPersonEstadoNascimento = document.getElementById('modalPersonEstadoNascimento'); // NOVO
        const modalPersonHistoryContainer = document.getElementById('modalPersonHistoryContainer');
        const modalPersonHistory = document.getElementById('modalPersonHistory');
        const modalEditButton = document.getElementById('modalEditButton');

        // Adiciona um listener para o evento 'show.bs.modal' (antes do modal ser exibido)
        personDetailsModal.addEventListener('show.bs.modal', function (event) {
            // O botão que disparou o modal
            const button = event.relatedTarget;
            // Extrai o ID da pessoa do atributo data-person-id do botão
            const personId = button.getAttribute('data-person-id');
            // Encontra os dados da pessoa no objeto 'personsData'
            const person = personsData[personId];

            if (person) {
                modalTitle.textContent = person.nome;
                modalPersonPhoto.src = person.foto_url; 
                modalPersonPhoto.alt = person.nome;
                modalPersonName.textContent = person.nome;
                modalPersonBirthDate.textContent = person.data_nascimento ? new Date(person.data_nascimento).toLocaleDateString('pt-BR') : 'Não informado';
                modalPersonAge.textContent = person.idade || 'N/A';
                
                if (person.data_falecimento) {
                    modalPersonDeathDate.textContent = new Date(person.data_falecimento).toLocaleDateString('pt-BR');
                } else if (person.data_falecimento_incerta) {
                    modalPersonDeathDate.textContent = `(Incerta) ${person.data_falecimento_incerta}`;
                } else {
                    modalPersonDeathDate.textContent = 'Vivo(a)';
                }

                modalPersonGender.textContent = person.genero;
                modalPersonRelationship.textContent = person.relacao;
                modalPersonStatus.textContent = person.status_vida;

                modalPersonLocalNascimento.textContent = person.local_nascimento || 'Não informado';
                modalPersonEstadoNascimento.textContent = person.estado_nascimento || 'Não informado'; // NOVO

                if (person.pai_id && personsData[person.pai_id]) {
                    const father = personsData[person.pai_id];
                    modalPersonFather.innerHTML = `<a href="/arvore/${father.id}/">${father.nome}</a>`;
                } else {
                    modalPersonFather.textContent = 'Não informado';
                }

                if (person.mae_id && personsData[person.mae_id]) {
                    const mother = personsData[person.mae_id];
                    modalPersonMother.innerHTML = `<a href="/arvore/${mother.id}/">${mother.nome}</a>`;
                } else {
                    modalPersonMother.textContent = 'Não informado';
                }

                if (person.historia_pessoal) {
                    modalPersonHistoryContainer.style.display = 'block';
                    modalPersonHistory.innerHTML = person.historia_pessoal.replace(/\n/g, '<br>');
                } else {
                    modalPersonHistoryContainer.style.display = 'none';
                    modalPersonHistory.textContent = '';
                }
                
                modalEditButton.href = `/pessoas/editar/${person.id}/`;
            }
        });
    </script>
</body>
</html>